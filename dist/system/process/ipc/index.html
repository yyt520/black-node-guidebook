<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/black-node-guidebook/umi.css" />
    <script>
      window.routerBase = "/black-node-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>进程间通信 - Node Guidebook</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/system/process/ipc" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/black-node-guidebook//">Node Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/black-node-guidebook//overview">概览</a></span><span><a href="/black-node-guidebook//engine">引擎</a></span><span><a aria-current="page" class="active" href="/black-node-guidebook//system">系统</a></span><span><a href="/black-node-guidebook//network">网络</a></span><span><a href="/black-node-guidebook//server-application">服务端应用</a></span><span><a href="/black-node-guidebook//util-application">工具应用</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/black-node-guidebook//"></a><h1>Node Guidebook</h1><p>Node 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/black-node-guidebook//overview">概览</a></li><li><a href="/black-node-guidebook//engine">引擎</a></li><li><a aria-current="page" class="active" href="/black-node-guidebook//system">系统</a></li><li><a href="/black-node-guidebook//network">网络</a></li><li><a href="/black-node-guidebook//server-application">服务端应用</a></li><li><a href="/black-node-guidebook//util-application">工具应用</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">进程</a><ul><li><a href="/black-node-guidebook//system/process/process"><span>进程 process</span></a></li><li><a href="/black-node-guidebook//system/process/child-process"><span>子进程 child_process</span></a></li><li><a href="/black-node-guidebook//system/process/cluster"><span>集群 cluster</span></a></li><li><a aria-current="page" class="active" href="/black-node-guidebook//system/process/ipc"><span>进程间通信</span></a></li><li><a href="/black-node-guidebook//system/process/daemon"><span>守护进程</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">异步 I/O</a><ul><li><a href="/black-node-guidebook//system/io/io"><span>概述</span></a></li><li><a href="/black-node-guidebook//system/io/buffer"><span>Buffer 缓冲器</span></a></li><li><a href="/black-node-guidebook//system/io/stream"><span>Stream 流</span></a></li><li><a href="/black-node-guidebook//system/io/readable-stream"><span>ReadableStream 可读流</span></a></li><li><a href="/black-node-guidebook//system/io/writable-stream"><span>WritableStream 可写流</span></a></li><li><a href="/black-node-guidebook//system/io/duplex-stream"><span>DuplexStream 双工流</span></a></li><li><a href="/black-node-guidebook//system/io/transform-stream"><span>TransformStream 转换流</span></a></li><li><a href="/black-node-guidebook//system/io/string-decoder"><span>StringDecoder 字符串解码</span></a></li><li><a href="/black-node-guidebook//system/io/path"><span>Path 路径</span></a></li><li><a href="/black-node-guidebook//system/io/filesystem"><span>File 文件系统</span></a></li><li><a href="/black-node-guidebook//system/io/console"><span>Console 控制台</span></a></li></ul></li><li><a href="/black-node-guidebook//system/process">进程</a><ul><li><a href="/black-node-guidebook//system/process/multiple-process-architecture"><span>多进程架构模型</span></a></li><li><a href="/black-node-guidebook//system/process/tmp"><span>Node.js 中的进程与线程</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="概念" data-depth="2"><a href="/black-node-guidebook//system/process/ipc#概念"><span>概念</span></a></li><li title="实现原理" data-depth="2"><a href="/black-node-guidebook//system/process/ipc#实现原理"><span>实现原理</span></a></li><li title="句柄传递" data-depth="2"><a href="/black-node-guidebook//system/process/ipc#句柄传递"><span>句柄传递</span></a></li><li title="句柄发送与还原" data-depth="3"><a href="/black-node-guidebook//system/process/ipc#句柄发送与还原"><span>句柄发送与还原</span></a></li><li title="端口共同监听" data-depth="3"><a href="/black-node-guidebook//system/process/ipc#端口共同监听"><span>端口共同监听</span></a></li><li title="其他方式实现进程间通信" data-depth="2"><a href="/black-node-guidebook//system/process/ipc#其他方式实现进程间通信"><span>其他方式实现进程间通信</span></a></li><li title="stdin/stdout" data-depth="3"><a href="/black-node-guidebook//system/process/ipc#stdinstdout"><span>stdin/stdout</span></a></li><li title="Sockets" data-depth="3"><a href="/black-node-guidebook//system/process/ipc#sockets"><span>Sockets</span></a></li><li title="消息队列" data-depth="3"><a href="/black-node-guidebook//system/process/ipc#消息队列"><span>消息队列</span></a></li><li title="Redis" data-depth="3"><a href="/black-node-guidebook//system/process/ipc#redis"><span>Redis</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="进程间通信"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#进程间通信"><span class="icon icon-link"></span></a>进程间通信</h1><ol><li>什么是 IPC 通信？</li><li>如何建立 IPC 通信？</li><li>什么场景下需要用到 IPC 通信？</li></ol><h2 id="概念"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#概念"><span class="icon icon-link"></span></a>概念</h2><p>IPC（Inter-process communication），即进程间通信技术，由于每个进程创建之后都有自己的独立地址空间，实现 IPC 的目的就是为了进程之间资源共享访问。</p><p>操作系统的进程间通信方式主要有以下几种：</p><ul><li><strong>共享内存</strong>：不同进程共享同一段内存空间。通常还需要引入信号量机制，来实现同步和互斥。</li><li><strong>消息传递</strong>：这种模式下，进程间通过发送、接收消息来实现信息的同步。</li><li><strong>信号量</strong>：信号量简单说就是系统赋予进程的一个状态值，未得到控制权的进程会在特定地方被迫停下来，等待可以继续进行的信号到来。如果信号量只有 0 或者 1 两个值的话，又被称作「互斥锁」。这个机制也被广泛用于各种编程模式中。</li><li><strong>管道</strong>：管道本身也是一个进程，它用于连接两个进程，将一个进程的输出作为另一个进程的输入。可以用 pipe 系统调用来创建管道。我们进程用的 <code>|</code> 命令行就是利用管道机制。</li></ul><h2 id="实现原理"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#实现原理"><span class="icon icon-link"></span></a>实现原理</h2><p>Node.js 中实现 IPC 通道的是管道（pipe）技术。但此管道并非彼管道，在 Node.js 中管道是个抽象层面的称呼，具体细节实现由 libuv 提供，在 Windows 下由命名管道（named pipe）实现，*nix 系统则采用 Unix Domain Socket 实现。表现在应用层上的进程间通信只有简单的 <code>message</code> 事件和 <code>send()</code> 方法，接口十分简洁和消息化。</p><p><img src="/black-node-guidebook/static/ipc-creation-and-realization.9d8f4056.jpg" alt="IPC创建和实现示意图"/></p><p>父进程在实际创建子进程之前，会创建 IPC 通道并监听它，然后才真正创建出子进程，并通过环境变量（NODE_CHANNEL_FD）告诉子进程这个 IPC 通道的文件描述符。子进程在启动的过程中，根据文件描述符去连接这个已存在的 IPC 通道，从而完成父子进程之间的连接。</p><p><img src="/black-node-guidebook/static/ipc-pipe-creation.db465a9d.jpg" alt="创建 IPC 管道的步骤示意图"/></p><p>建立连接之后的父子进程就可以自由地通信了。由于 IPC 通道是用明明管道或 Domain SOcket 创建的，它们与网络 socket 的行为比较类似，属于双向通信。不同的是它们在系统内核中就完成了进程间的通信，而不同经过实际的网络层，非常高效。在 Node 中，IPC 通道被抽象为 Stream 对象，在调用 <code>send()</code> 时发送数据（类似于 <code>write()</code>）接收到的消息会通过 <code>message</code> 事件（类似于 <code>data</code>）触发给应用层。</p><blockquote><p>⚠️ 注意：只有启动的子进程是 Node 进程时，子进程才会根据环境变量去连接 IPC 通道，对于其他类型的子进程则无法实现进程间通信，除非其他进程也按约定去连接这个已经创建好的 IPC 通信。</p></blockquote><h2 id="句柄传递"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#句柄传递"><span class="icon icon-link"></span></a>句柄传递</h2><p>通过代理，可以避免父子进程不能重复监听相同端口的问题，甚至可以在代理进程上做适当的负载均衡，使得每个子进程可以较为均衡地执行任务。由于进程每接收到一个连接，将会用掉一个文件描述符，因此代理方案中客户端连接到代理进程，代理进程连接到工作进程的过程需要用掉两个文件描述符。操作系统的文件描述符是有限的，代理方案浪费掉一倍数量的文件描述符的做法影响了系统的扩展能力。</p><p>为了解决上述问题，Node 在版本 v0.5.9 引入了进程间发送句柄的功能。<code>send()</code> 方法除了能通过 IPC 发送数据外，还能发送句柄，第二个可选参数就是句柄。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">child.send(message, [sendHandle])</span></div></pre></div><p>句柄是一种可以用来标识资源的引用，它的内部包含了指向对象的文件描述符。比如句柄可以用来标识一个服务端 socket 对象、一个客户端 socket 对象、一个 UDP 套接字、一个管道等。</p><p>发送句柄意味着什么我们可以去掉代理的方案，使主进程收到 socket 请求后，将这个 socket 直接发送给对应的工作进程，而不是重新与工作进程之间建立新的 socket 连接来转发数据。文件描述符浪费的问题可以通过这样的方式轻松解决。</p><p>而我们也可以将主进程更轻量化，通过将主进程的服务器句柄发送给子进程后，关闭服务器的监听，让子进程来处理请求。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// master</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> childProcess </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;child_process&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> child1 </span><span class="token operator">=</span><span class="token plain"> childProcess</span><span class="token punctuation">.</span><span class="token method function property-access">fork</span><span class="token punctuation">(</span><span class="token string">&#x27;worker1.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> child2 </span><span class="token operator">=</span><span class="token plain"> childProcess</span><span class="token punctuation">.</span><span class="token method function property-access">fork</span><span class="token punctuation">(</span><span class="token string">&#x27;worker2.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;net&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">server</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">1337</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  child1</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">&#x27;server&#x27;</span><span class="token punctuation">,</span><span class="token plain"> server</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  child2</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">&#x27;server&#x27;</span><span class="token punctuation">,</span><span class="token plain"> server</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 关闭服务器监听</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  server</span><span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// worker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> http </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">reuqire</span><span class="token punctuation">(</span><span class="token string">&#x27;http&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string-property property">&#x27;Content-Type&#x27;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;text/plain&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">&#x27;Handled by child, pid is &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;\n&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token parameter punctuation">,</span><span class="token parameter"> tcp</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">m </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;server&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    tcp</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;connection&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      server</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;connection&#x27;</span><span class="token punctuation">,</span><span class="token plain"> socket</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p><strong>主进程将请求发送给工作进程</strong></p><p><img src="/black-node-guidebook/static/master-process-send-request-to-worker.43f6c93a.jpg" alt="主进程将请求发送给工作进程"/></p><p><strong>主进程发送完句柄并关闭监听后的结构</strong></p><p><img src="/black-node-guidebook/static/master-send-handler-and-close-listen.408bd9d7.jpg" alt="主进程发送完句柄并关闭监听后的结构"/></p><h3 id="句柄发送与还原"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#句柄发送与还原"><span class="icon icon-link"></span></a>句柄发送与还原</h3><p>仔细看上文介绍的句柄发送，其实存在以下几个疑问：</p><ul><li>句柄发送与我们直接将服务器对象发送给子进程有没有差别？</li><li>它是否真的将服务器对象发送给了子进程？</li><li>为什么它可以发送到多个子进程中？</li><li>发送给子进程为什么父进程中还存在这个对象？</li></ul><p>目前子进程对象 <code>send()</code> 方法可以发送的句柄类型包括如下几种：</p><ul><li><code>net.Socket</code>：TCP 套接字</li><li><code>net.Server</code>：TCP 服务器，任意建立在 TCP 服务上的应用层服务都可以享受到它带来的好处</li><li><code>net.Native</code>：C++ 层面的 TCP 套接字或 IPC 管道</li><li><code>dgram.Socket</code>：UDP 套接字</li><li><code>dgram.Native</code>：C++ 层面的 UDP 套接字</li></ul><p><code>send()</code> 方法在将消息发送到 IPC 管道前，将消息组装成两个对象，一个参数是 handle，另一个是 message。message 参数如下所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">cmd</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;NODE_HANDLE&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;net.Server&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token plain"> message</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>发送到 IPC 管道中的实际上是我们要发送的句柄文件描述符，文件描述符实际上是一个整数值。这个 message 对象在写入 IPC 管道时也会通过 <code>JSON.stringify()</code> 进行序列化。所以最终发送到 IPC 通道中的信息都是字符串，<code>send()</code> 方法能发送消息和句柄并不意味着它能发送任意对象。</p><p>连接了 IPC 通道的子进程可以读取到父进程发来的消息，将字符串通过 <code>JSON.parse()</code> 解析还原为对象后，才触发 <code>message</code> 事件将消息体传递给应用层使用。在这个过程中，消息对象还要被进行过滤处理，<code>message.cmd</code> 的值如果以 <code>NODE_</code> 为前缀，它将响应一个内部事件 <code>internalMessage</code>。如果 <code>message.cmd</code> 值为 <code>NODE_HANDLE</code>，它将取出 <code>message.type</code> 值和得到的文件描述符一起还原出一个对应的对象。</p><p><img src="/black-node-guidebook/static/ipc-handle-send-and-parse.82c68647.jpg" alt="句柄的发送与还原示意图"/></p><p>以发送 TCP 服务器句柄为例，子进程收到消息后的还原过程如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token parameter punctuation">,</span><span class="token parameter"> handle</span><span class="token parameter punctuation">,</span><span class="token parameter"> emit</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> self </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">net</span><span class="token class-name punctuation">.</span><span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  server</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token plain">handle</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token plain">server</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>子进程根据 <code>message.type</code> 创建对应 TCP 服务器对象，然后监听到文件描述符上。由于底层细节不被应用层感知，所以在子进程中，开发者会有一种服务器就是从父进程中直接传递过来的错觉。值得注意的是，Node.js 进程之间只有消息传递，不会真正地传递对象，这种错觉是抽象封装的结果。</p><p>目前 Node 只支持上述提到的几种句柄，并非任意类型的句柄都能在进程之间传递，除非它有完整的发送和还原的过程。</p><h3 id="端口共同监听"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#端口共同监听"><span class="icon icon-link"></span></a>端口共同监听</h3><p>了解句柄传递背后的原理后，我们探究为何通过发送句柄后，多个进程可以监听到相同的端口而不引起 <code>EDDRINUSE</code> 异常。其实答案很简单，我们独立启动的进程中，TCP 服务器端 socket 套接字的文件描述符并不相同，导致监听到相同的端口时会抛出异常。</p><p>Node 底层对每个端口监听都设置了 <code>SO_REUSEADDR</code> 选项，这个选项的含义是不同进程可以就相同的网卡和端口进行监听，这个服务器端套接字可以被不同的进程复用。</p><div class="__dumi-default-code-block"><pre class="prism-code language-cpp"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token plain">tcp</span><span class="token operator">-&gt;</span><span class="token plain">op_watcher</span><span class="token punctuation">.</span><span class="token plain">fd</span><span class="token punctuation">,</span><span class="token plain"> SOL_SOCKET</span><span class="token punctuation">,</span><span class="token plain"> SO_REUSEADDR</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">on</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token plain">on</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>由于独立启动的进程互相之间并不知道文件描述符，所以监听相同端口就会失败。但对于 <code>send()</code> 发送的句柄还原出来的服务而言，它们的文件描述符是相同的，所以监听相同端口不会引起异常。</p><p>多个应用监听相同端口时，文件描述符同一时间只能被某个进程所用。换言之就是网络请求向服务器端发送时，只有一个幸运的进程能够抢到连接，也就是说只有它能为这个请求进行服务。这些进程服务是抢占式的。</p><h2 id="其他方式实现进程间通信"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#其他方式实现进程间通信"><span class="icon icon-link"></span></a>其他方式实现进程间通信</h2><p>除了通过 Node 内置的 IPC 机制实现进程间通信外，还可以通过 stdin/stdout、sockets、消息队列和 Redis 等方式实现进程间通信。</p><h3 id="stdinstdout"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#stdinstdout"><span class="icon icon-link"></span></a>stdin/stdout</h3><p>最直接的通信方式，取得子进程的句柄后，可以访问其 stdio 流，通过约定 message 格式进行通信：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> spawn </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;child_process&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> child </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">&#x27;node&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;./worker.js&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">child</span><span class="token punctuation">.</span><span class="token property-access">stdout</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 父进程发送消息</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">child</span><span class="token punctuation">.</span><span class="token property-access">stdin</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;handshake&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">payload</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;Hello world!&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 父进程接收消息</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">child</span><span class="token punctuation">.</span><span class="token property-access">stdout</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> chunk</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> message </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">message</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">type</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">message</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">payload</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>子进程与之类似：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// ./worker.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 子进程接收</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">stdin</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">chunk</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> chunk</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> message </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">message</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&#x27;handshake&#x27;</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 子进程发送</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      process</span><span class="token punctuation">.</span><span class="token property-access">stdout</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token literal-property property">payload</span><span class="token operator">:</span><span class="token plain"> message</span><span class="token punctuation">.</span><span class="token property-access">payload</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27; : HoHoHo&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>VS Code 进程间通信就采用这种方式。明显的限制是需要取得子进程的 handle，两个完全独立的进程之间无法通过这种方式来通信（比如跨应用，甚至跨机器的场景）。</p><h3 id="sockets"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#sockets"><span class="icon icon-link"></span></a>Sockets</h3><p>借助网络来完成进程间通信，不仅能跨进程，还能跨机器。</p><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/RIAEvangelist/node-ipc">node-ipc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 就采用这种方案，查看<a target="_blank" rel="noopener noreferrer" href="https://github.com/RIAEvangelist/node-ipc/tree/master/example">更多 node-ipc 示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>当然，单机场景下通过网络来完成进程间通信有些浪费性能，但网络通信的优势在于跨环境的兼容性与更进一步的 RPC 场景。</p><h3 id="消息队列"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#消息队列"><span class="icon icon-link"></span></a>消息队列</h3><p>父子进程都通过外部消息机制来通信，跨进程的能力取决于 MQ 支持。</p><p>即进程间不直接通信，而是通过中间层（MQ），加一个控制层就能获得更多灵活性和优势：</p><ul><li><strong>稳定性</strong>：消息机制提供了强大的稳定性保证，比如确认送达（消息回执 ACK），失败重发 / 防止多发等等</li><li><strong>优先级控制</strong>：允许调整消息响应次序</li><li><strong>离线能力</strong>：消息可以被缓存</li><li><strong>事务性消息处理</strong>：把关联消息组合成事务，保证其送达顺序及完整性</li></ul><p>比较受欢迎的库有 <a target="_blank" rel="noopener noreferrer" href="https://github.com/smrchy/rsmq">smrchy/rsmq<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>会启用一个 Redis Server，基本原理如下：</p><blockquote><p>Using a shared Redis server multiple Node.js processes can send / receive messages.</p></blockquote><p>消息的收/发/缓存/持久化依靠 Redis 提供的能力，在此基础上实现完整的队列机制。</p><h3 id="redis"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/ipc#redis"><span class="icon icon-link"></span></a>Redis</h3><p>基本思路与消息队列类似</p><blockquote><p>Use Redis as a message bus/broker.</p></blockquote><p>Redis 自带 Pub/Sub 机制（即发布-订阅模式），适用于简单的通信场景，比如一对一或一对多并且不关注消息可靠性的场景。</p><p>另外，Redis 有 list 结构，可以用作消息队列，以此提高消息可靠性。一般做法是生产者 LPUSH 消息，消费者 BRPOP 消息。适用于要求消息可靠性的简单通信场景，但缺点是消息不具状态，且没有 ACK 机制，无法满足复杂的通信需求。</p><p><a target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/questions/6463945/whats-the-most-efficient-node-js-inter-process-communication-library-method">Redis 的 Pub/Sub 示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><hr/><p><strong>参考资料：</strong></p><ul><li><a target="_blank" rel="noopener noreferrer" href="http://product.dangdang.com/23371791.html">📚 《深入浅出 Node.js》：第九章 玩转进程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://blog.csdn.net/clschen/article/details/51181246">📝 进程间通信的另类实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-node-guidebook/edit/master/docs/system/process/ipc.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2023/7/9 19:47:35</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/black-node-guidebook/umi.js"></script>
  </body>
</html>
