<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/black-node-guidebook/umi.css" />
    <script>
      window.routerBase = "/black-node-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>Node.js 中的进程与线程 - Node Guidebook</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/system/process/tmp" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/black-node-guidebook//">Node Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/black-node-guidebook//overview">概览</a></span><span><a href="/black-node-guidebook//engine">引擎</a></span><span><a aria-current="page" class="active" href="/black-node-guidebook//system">系统</a></span><span><a href="/black-node-guidebook//network">网络</a></span><span><a href="/black-node-guidebook//server-application">服务端应用</a></span><span><a href="/black-node-guidebook//util-application">工具应用</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/black-node-guidebook//"></a><h1>Node Guidebook</h1><p>Node 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/black-node-guidebook//overview">概览</a></li><li><a href="/black-node-guidebook//engine">引擎</a></li><li><a aria-current="page" class="active" href="/black-node-guidebook//system">系统</a></li><li><a href="/black-node-guidebook//network">网络</a></li><li><a href="/black-node-guidebook//server-application">服务端应用</a></li><li><a href="/black-node-guidebook//util-application">工具应用</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">进程</a><ul><li><a href="/black-node-guidebook//system/process/process"><span>进程 process</span></a></li><li><a href="/black-node-guidebook//system/process/child-process"><span>子进程 child_process</span></a></li><li><a href="/black-node-guidebook//system/process/cluster"><span>集群 cluster</span></a></li><li><a href="/black-node-guidebook//system/process/ipc"><span>进程间通信</span></a></li><li><a href="/black-node-guidebook//system/process/daemon"><span>守护进程</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">异步 I/O</a><ul><li><a href="/black-node-guidebook//system/io/io"><span>概述</span></a></li><li><a href="/black-node-guidebook//system/io/buffer"><span>Buffer 缓冲器</span></a></li><li><a href="/black-node-guidebook//system/io/stream"><span>Stream 流</span></a></li><li><a href="/black-node-guidebook//system/io/readable-stream"><span>ReadableStream 可读流</span></a></li><li><a href="/black-node-guidebook//system/io/writable-stream"><span>WritableStream 可写流</span></a></li><li><a href="/black-node-guidebook//system/io/duplex-stream"><span>DuplexStream 双工流</span></a></li><li><a href="/black-node-guidebook//system/io/transform-stream"><span>TransformStream 转换流</span></a></li><li><a href="/black-node-guidebook//system/io/string-decoder"><span>StringDecoder 字符串解码</span></a></li><li><a href="/black-node-guidebook//system/io/path"><span>Path 路径</span></a></li><li><a href="/black-node-guidebook//system/io/filesystem"><span>File 文件系统</span></a></li><li><a href="/black-node-guidebook//system/io/console"><span>Console 控制台</span></a></li></ul></li><li><a aria-current="page" class="active" href="/black-node-guidebook//system/process">进程</a><ul><li><a href="/black-node-guidebook//system/process/multiple-process-architecture"><span>多进程架构模型</span></a></li><li><a aria-current="page" class="active" href="/black-node-guidebook//system/process/tmp"><span>Node.js 中的进程与线程</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="Node.js 中的进程与线程" data-depth="2"><a href="/black-node-guidebook//system/process/tmp#nodejs-中的进程与线程"><span>Node.js 中的进程与线程</span></a></li><li title="process 模块" data-depth="3"><a href="/black-node-guidebook//system/process/tmp#process-模块"><span>process 模块</span></a></li><li title="child_process 模块" data-depth="3"><a href="/black-node-guidebook//system/process/tmp#child_process-模块"><span>child_process 模块</span></a></li><li title="cluster 模块" data-depth="3"><a href="/black-node-guidebook//system/process/tmp#cluster-模块"><span>cluster 模块</span></a></li><li title="IPC 进程通信原理" data-depth="3"><a href="/black-node-guidebook//system/process/tmp#ipc-进程通信原理"><span>IPC 进程通信原理</span></a></li><li title="关于单线程的误区" data-depth="3"><a href="/black-node-guidebook//system/process/tmp#关于单线程的误区"><span>关于单线程的误区</span></a></li><li title="存在异步 I/O 占用额外线程" data-depth="3"><a href="/black-node-guidebook//system/process/tmp#存在异步-io-占用额外线程"><span>存在异步 I/O 占用额外线程</span></a></li><li title="线程创建方式" data-depth="3"><a href="/black-node-guidebook//system/process/tmp#线程创建方式"><span>线程创建方式</span></a></li><li title="其他" data-depth="2"><a href="/black-node-guidebook//system/process/tmp#其他"><span>其他</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h2 id="nodejs-中的进程与线程"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#nodejs-中的进程与线程"><span class="icon icon-link"></span></a>Node.js 中的进程与线程</h2><p>Node.js 是 JavaScript 在服务端的运行环境，构建在 Chrome 的 V8 引擎之上，基于事件驱动、非阻塞 I/O 模型，充分利用操作系统提供的异步 I/O 进行多任务的执行，适合于 I/O 密集型的应用场景，因为异步，程序无需阻塞等待结果返回，而是基于回调通知的机制，原本同步模式等待的时间，则可以用来处理其它任务，</p><blockquote><p>科普：在 Web 服务器方面，著名的 Nginx 也是采用此模式（事件驱动），避免了多线程的线程创建、线程上下文切换的开销，Nginx 采用 C 语言进行编写，主要用来做高性能的 Web 服务器，不适合做业务。</p></blockquote><p>Web 业务开发中，如果你有高并发应用场景那么 Node.js 会是你不错的选择。</p><ul><li>在单核 CPU 系统之上我们采用 <code>单进程 + 单线程</code> 的模式来开发。</li><li>在多核 CPU 系统之上，可以通过 <code>child_process.fork</code> 开启多个进程（Node.js 在 v0.8 版本之后新增了 <strong>Cluster</strong> 模块来实现多进程架构） ，即 <code>多进程 + 单线程</code> 模式。</li></ul><p>⚠️ <strong>注意</strong>：开启多进程不是为了解决高并发，主要是解决了单进程模式下 Node.js CPU 利用率不足的情况，充分利用多核 CPU 的性能。</p><h3 id="process-模块"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#process-模块"><span class="icon icon-link"></span></a>process 模块</h3><p>Node.js 中的进程 <code>process</code> 是一个全局对象，无需 <code>require</code> 则可直接使用，给我们提供了当前进程中的相关信息。官方文档提供了详细的说明，感兴趣的可以亲自实践下 <a target="_blank" rel="noopener noreferrer" href="http://nodejs.cn/api/process.html">process 模块<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p><p>在 Node.js 程序中直接打印 <code>process</code> 可以直接获取非常多有用的属性以及方法：</p><ul><li>进程基础信息</li><li>进程 Usage</li><li>进程级事件</li><li>依赖模块/版本信息</li><li>OS 基础信息</li><li>账户信息</li><li>信号收发</li><li>三个标准流</li></ul><h3 id="child_process-模块"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#child_process-模块"><span class="icon icon-link"></span></a>child_process 模块</h3><p>进程创建有多种方式，主要使用 Node.js 的另外两个模块：<a href="/black-node-guidebook//system/process/child-process">child_process</a> 模块和 <a href="/black-node-guidebook//system/process/cluster">cluster</a> 模块。</p><p><code>child_process</code> 是 Node.js 的内置模块，用于创建子进程。</p><p>几个常用函数： 四种方式：</p><ul><li><code>child_process.spawn</code>：适用于返回 <strong>大量数据</strong>，例如图像处理，二进制数据处理。</li><li><code>child_process.exec</code>：适用于 <strong>小量数据</strong>，<code>maxBuffer</code> 默认值为 200 * 1024 超出这个默认值将会导致程序崩溃，数据量过大可采用 <code>spawn</code>。</li><li><code>child_process.execFile</code>：类似 <code>child_process.exec</code>，区别是不能通过 Shell 来执行，不支持像 I/O 重定向和文件查找这样的行为</li><li><code>child_process.fork</code>： 衍生新的进程，进程之间是相互独立的，每个进程都有自己的 V8 实例、内存，系统资源是有限的，不建议衍生太多的子进程出来，通常根据系统 <strong>CPU 核心数</strong>设置。</li></ul><p>CPU 核心数这里特别说明下，<code>fork</code> 确实可以开启多个进程，但是并不建议衍生出来太多的进程，CPU 核心数的获取方式：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> cpus </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;os&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>这里 <code>cpus</code> 返回一个对象数组，包含所安装的每个 CPU 内核的信息，二者总和的数组。</p><p>假设主机装有两个 CPU，每个 CPU 有 4 个核，那么总核数就是 8。</p><h3 id="cluster-模块"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#cluster-模块"><span class="icon icon-link"></span></a>cluster 模块</h3><p>Cluster 模块调用 <code>fork</code> 方法来创建子进程，该方法与 <code>child_process</code> 中的 <code>fork</code> 是同一个方法。</p><p>Cluster 模块采用的是经典的 <strong>主从模型</strong>，Cluster 会创建一个 <code>master</code>，然后根据你指定的数量复制出多个子进程，可以使用 <code>cluster.isMaster</code> 属性判断当前进程是 <code>master</code> 还是 <code>worker</code>（工作进程）。由 <code>master</code> 进程来管理所有的子进程，主进程不负责具体的任务处理，主要工作是 <strong>负责调度和管理</strong>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> cluster </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;cluster&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> http </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;http&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> numCPUs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;os&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">cluster</span><span class="token punctuation">.</span><span class="token property-access">isMaster</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Master </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">process</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">pid</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> is running</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Fork workers</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> numCPUs</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    cluster</span><span class="token punctuation">.</span><span class="token method function property-access">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  cluster</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;exit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">worker</span><span class="token parameter punctuation">,</span><span class="token parameter"> code</span><span class="token parameter punctuation">,</span><span class="token parameter"> signal</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">worker </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">worker</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">process</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">pid</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> died</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Wokers can share any TCP connection</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// In this case it is an HTTP server</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  http</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      res</span><span class="token punctuation">.</span><span class="token method function property-access">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      res</span><span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">&#x27;Hello world\n&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Worker </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">process</span><span class="token template-string interpolation punctuation">.</span><span class="token template-string interpolation property-access">pid</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string"> started</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>Cluster 模块使用 <strong>内置的负载均衡</strong> 来更好地处理线程之间的压力，该负载均衡使用了 RoundRobin 算法（也被称之为循环算法）。当使用 RoundRobin 调度策略时，<code>master</code> 的 <code>accepts</code> 所有传入的连接请求，然后将相应的 TCP 请求处理发送给选中的工作进程（该方式仍然通过 IPC 来进行通信）。</p><blockquote><p>如果多个 Node 进程监听同一个端口时会出现 <code>Error:listen EADDRIUNS</code> 的错误，而 <code>cluster</code> 模块为什么可以让多个子进程监听同一个端口呢？</p></blockquote><p>原因是 <code>master</code> 进程内部启动了一个 TCP 服务器，而真正监听端口的只有这个服务器，当来自前端的请求触发服务器的 <code>connection</code> 事件后，<code>master</code> 会将对应的 <code>socket</code> 句柄发送给子进程。</p><h3 id="ipc-进程通信原理"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#ipc-进程通信原理"><span class="icon icon-link"></span></a>IPC 进程通信原理</h3><p>前面讲解的无论是 <code>child_process</code> 模块，还是 <code>cluster</code> 模块，都需要主进程和工作进程之间的通信。通过 <code>fork</code> 或者其他 API，创建子进程之后，为了实现父子进程之间的通信，父子进程之间才能通过 <code>message</code> 方法和 <code>send</code> 方法传递信息。</p><p>IPC 这个词我想大家并不陌生，不管哪一种开发语言都会提到进程通信，都会提到它。IPC 的全称是 Inter-Process Communication，即 <strong>进程间通信</strong>。</p><p>它的目的是为了让 <strong>不同的进程</strong> 能够互相访问资源并进行协调工作。实现进程间通信的技术有很多，如 <strong>命名管道</strong>、<strong>匿名管道</strong>、<strong>Socket</strong>、<strong>信号量</strong>、<strong>共享内存</strong>、<strong>消息队列</strong> 等。</p><p>Node 中实现 IPC 通道是依赖于 <code>libuv</code>：</p><ul><li>Window 下由命名管道（name pipe）实现</li><li>*nix 系统则采用 Unix Domain Socket 实现</li></ul><p>表现在应用层上的进程间通信只有简单的 <code>message</code> 事件和 <code>send</code> 方法，接口十分简洁和消息化。</p><br/></div><img alt="容器状态流转图" src="/black-node-guidebook/static/ipc-creation.b82032c0.png" width="520"/><div class="markdown"><br/><p>IPC 通信管道是如何创建的：</p><br/></div><img alt="容器状态流转图" src="/black-node-guidebook/static/ipc-pipe-creation.13cedafe.jpeg" width="520"/><div class="markdown"><br/><p>父进程在实际创建子进程之前，会创建 IPC 通道并监听它，然后才真正的创建出子进程，这个进程中也会通过环境变量（<code>NODE_CHANNEL_FD</code>）告诉子进程这个 IPC 通道的文件描述符。子进程在启动的过程中，根据文件描述符去连接这个已存在的 IPC 通道，从而完成父子进程之间的连接。</p><h4 id="句柄传递"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#句柄传递"><span class="icon icon-link"></span></a>句柄传递</h4><blockquote><p>讲句柄之前，先想一个问题，<code>send</code> 句柄发送的时候，真的是将服务器对象发送给子进程？</p></blockquote><p><strong>子进程对象 <code>send</code> 方法可以发送的句柄类型</strong></p><ul><li><code>net.Socket</code>：TCP 套接字</li><li><code>net.Server</code>：TCP 服务器，任意建立在 TCP 服务上的应用层服务都可以享受它带来的好处</li><li><code>net.Native</code>：C++ 层面的 TCP 套接字或 IPC 管道</li><li><code>dgram.Socket</code>：UDP 套接字</li><li><code>dgram.Native</code>：C++ 层面的 UDP 套接字</li></ul><p><strong>send 句柄发送原理分析</strong></p><p>结合句柄的发送与还原示意图更容易理解。</p></div><img alt="容器状态流转图" src="/black-node-guidebook/static/send-handle.e2b046ef.jpeg" width="520"/><div class="markdown"><p><code>send</code> 方法在将消息发送到 IPC 管道前，实际将消息组装成了两个对象，一个参数是 <code>hadler</code>，另一个是 <code>message</code>。</p><p><code>message</code> 参数如下所示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">cmd</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;NODE_HANDLE&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;net.Server&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token plain"> message</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>发送到 IPC 管道中的实际上是我们要发送的是 <strong>句柄文件描述符</strong>。这个 <code>message</code> 对象在写入到 IPC 管道时，也会通过 <code>JSON.stringfy()</code> 进行序列化。所以最终发送到 IPC 通道中的信息都是字符串，<code>send</code> 方法能发送消息和句柄并不意味着它能发送任何对象。</p><p>连接了 IPC 通道的子线程可以读取父进程发来的消息，将字符串通过 <code>JSON.parse()</code> 解析还原为对象后，才触发 message 事件将消息传递给应用层使用。在这个过程中，消息对象还要被进行过滤处理，<code>message.cmd</code> 的值如果以 <code>NODE_</code> 为前缀，它将响应一个内部事件 <code>internalMessage</code>，如果 <code>message.cmd</code> 值为 NODE_HANDLE，它将取出 <code>message.type</code> 值和得到的文件描述符一起还原出一个对应的对象。</p><p>以发送的 TCP 服务器句柄为例，子进程收到消息后的还原过程代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token parameter punctuation">,</span><span class="token parameter">handle</span><span class="token parameter punctuation">,</span><span class="token parameter">emit</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> self </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">net</span><span class="token class-name punctuation">.</span><span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    server</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token plain">handler</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token plain">server</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>这段还原代码，子进程根据 <code>message.type</code> 创建对应的 TCP 服务器对象，然后监听到文件描述符上。由于底层细节不被应用层感知，所以子进程中，开发者会有一种服务器对象就是从父进程中直接传递过来的错觉。</p><blockquote><p>Node 进程之间只有消息传递，不会真正的传递对象，这种错觉是抽象封装的结果。目前 Node 只支持我前面提到的几种句柄，并非任意类型的句柄都能在进程之间传递，除非它有完整的发送和还原的过程。</p></blockquote><h4 id="多进程架构模型"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#多进程架构模型"><span class="icon icon-link"></span></a>多进程架构模型</h4><p>以下通过代码实现多进程架构模型示例：</p></div><img alt="容器状态流转图" src="/black-node-guidebook/static/mutiprocess-architecture.e6d0e441.png" width="520"/><div class="markdown"><p><strong>主进程：</strong></p><p><code>master.js</code> 主要处理以下逻辑：</p><ul><li>创建一个 Server 并监听 3000 端口</li><li>根据系统 CPUS 开启多个子进程</li><li>通过子进程对象的 send 方法发送消息到子进程进行通信</li><li>在主进程中监听了子进程的变化，如果是自杀信号重新启动一个工作进程</li><li>主进程在监听到退出消息的时候，先退出子进程再退出主进程</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// master.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> fork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;child_process&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">fork</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> cpus </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;os&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;net&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">server</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;node-master&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> workers </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">createWorker</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">&#x27;worker.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">massage</span><span class="token punctuation">.</span><span class="token property-access">act</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;suicide&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;exit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token parameter punctuation">,</span><span class="token parameter"> signal</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;worker process exited, code: %s signal: %s&#x27;</span><span class="token punctuation">,</span><span class="token plain"> code</span><span class="token punctuation">,</span><span class="token plain"> signal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">delete</span><span class="token plain"> workers</span><span class="token punctuation">[</span><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">&#x27;server&#x27;</span><span class="token punctuation">,</span><span class="token plain"> server</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workers</span><span class="token punctuation">[</span><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> worker</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;worker process created, pid: %s ppid: %s&#x27;</span><span class="token punctuation">,</span><span class="token plain"> worker</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">,</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> cpus</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;SIGINT&#x27;</span><span class="token punctuation">,</span><span class="token plain"> close</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;SIGINT&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// kill(2) Ctrl-C</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;SIGQUIT&#x27;</span><span class="token punctuation">,</span><span class="token plain"> close</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;SIGQUIT&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// kill(3) Ctrl-\</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;SIGTERM&#x27;</span><span class="token punctuation">,</span><span class="token plain"> close</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;SIGTERM&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// kill(15) default</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;exit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> close</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">close</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;进程退出&#x27;</span><span class="token punctuation">,</span><span class="token plain"> code</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">code </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> pid </span><span class="token keyword">in</span><span class="token plain"> workers</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;master process exited, kill worker pid:&#x27;</span><span class="token punctuation">,</span><span class="token plain"> pid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      workers</span><span class="token punctuation">[</span><span class="token plain">pid</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">kill</span><span class="token punctuation">[</span><span class="token string">&#x27;SIGINT&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  process</span><span class="token punctuation">.</span><span class="token method function property-access">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p><strong>子进程：</strong></p><p><code>worker.js</code> 子进程处理逻辑如下：</p><ul><li>创建一个 Server 对象，注意这里最开始并没有监听 3000 端口</li><li>通过 message 事件接收主进程 send 方法发送的消息</li><li>监听 uncaughtException 事件，捕获未处理的异常，发送自杀信息由主进程重建进程，子进程在链接关闭之后退出</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// worker.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> http </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;http&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token parameter punctuation">,</span><span class="token parameter"> res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string-property property">&#x27;Content-Type&#x27;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;text/plain&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">&#x27;I am worker, pid:&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;, ppid:&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token property-access">ppid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 测试异常进程退出、重启</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">throw</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;worker process exception!&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> worker</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;node-worker&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;messsage&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token parameter punctuation">,</span><span class="token parameter"> sendHandle</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">message </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;server&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    worker </span><span class="token operator">=</span><span class="token plain"> sendHandle</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;connection&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      server</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;connection&#x27;</span><span class="token punctuation">,</span><span class="token plain"> socket</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;uncaguhtException&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  process</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">act</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;suicide&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    process</span><span class="token punctuation">.</span><span class="token method function property-access">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><h4 id="进程守护"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#进程守护"><span class="icon icon-link"></span></a>进程守护</h4><blockquote><p><strong>什么是进程守护？</strong></p></blockquote><p>每次启动 Node.js 程序都需要在命令窗口输入命令 <code>node app.js</code> 才能启动，但如果把命令窗口关闭则 Node.js 程序服务就会立刻断掉。除此之外，当我们这个 Node.js 服务意外奔溃了就不能自动重启进程了。这些现象都不是我们想要看到的，所以需要通过某些方式来守护这个开启的进程，执行 <code>node app.js</code> 开启一个服务进程之后，我们还可以在这个终端上做些别的事情，且不会相互影响，当出现问题可以自动重启。</p><blockquote><p><strong>如何实现进程守护</strong></p></blockquote><p>这里只说一些第三方的进程守护框架，<a target="_blank" rel="noopener noreferrer" href="https://pm2.keymetrics.io/">pm2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a target="_blank" rel="noopener noreferrer" href="https://github.com/foreversd/forever#readme">forever<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它们都可以实现进程守护，底层也都是通过上面讲的 child_process 模块和 cluster 模块实现的，这里就不再提它们的原理。</p><h4 id="linux-关闭进程"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#linux-关闭进程"><span class="icon icon-link"></span></a>Linux 关闭进程</h4><p>通过 Linux 命令查找进程</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">ps</span><span class="token plain"> aux </span><span class="token operator">|</span><span class="token plain"> </span><span class="token function">grep</span><span class="token plain"> server</span></div></pre></div><p>杀死进程</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 优雅的方式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># -l 选项告诉 kill 命令用好像启动进程的用户已注销的方式结束进程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 当使用该选项时，kill 命令也试图杀死所留下的子进程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 但这个命令也不是总能成功，或许仍然需要先手工杀死子进程，然后再杀死父进程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">kill</span><span class="token plain"> -l </span><span class="token punctuation">[</span><span class="token plain">PID</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># kill 命令用于终止进程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># -9 表示强迫进程立即停止</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">kill</span><span class="token plain"> -9 </span><span class="token punctuation">[</span><span class="token plain">PID</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 杀死同一进程内的所有进程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 其允许指定要终止的进程名称，而非 PID</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">killall</span><span class="token plain"> httpd</span></div></pre></div><h3 id="关于单线程的误区"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#关于单线程的误区"><span class="icon icon-link"></span></a>关于单线程的误区</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> http </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;http&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> http</span><span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">server</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  process</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;测试进程&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;进程ID：&#x27;</span><span class="token punctuation">,</span><span class="token plain"> process</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>上述代码中创建了 HTTP 服务，开启了一个进程，都说 Node.js 是单线程，所以 Node.js 启动后线程数应该为 1，但是为什么会开启了 7 个线程呢？</p><p>Node.js 中最核心的是 V8 引擎，会创建 V8 的实例，这个实例是多线程的。</p><ul><li>主线程：编译、执行代码</li><li>编译/优化线程：在主线程执行的时候，可以优化代码</li><li>分析器线程：记录分析代码运行时间，为 Crankshaft 优化代码执行提供依据</li><li>垃圾回收的几个线程</li></ul><p>所以大家常说的 Node.js 是单线程的指的是 JavaScript 的执行是单线程的（开发者编写的代码运行在单线程环境中），但 JavaScript 的宿主环境，无论是 Node.js 还是浏览器都是多线程的因为 libuv 中有线程池的概念存在的，libuv 会通过类似线程池的实现来模拟不同操作系统的异步调用，这对开发者来说是不可见的。</p><h3 id="存在异步-io-占用额外线程"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#存在异步-io-占用额外线程"><span class="icon icon-link"></span></a>存在异步 I/O 占用额外线程</h3><p>还是上面的例子，我们在定时器执行的同时，去读一个文件：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">fs</span><span class="token punctuation">.</span><span class="token method function property-access">readFile</span><span class="token punctuation">(</span><span class="token string">&#x27;./index.html&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>线程数量变成了 11 个，这是因为在 Node 中有一些 I/O 操作（DNS，FS）和一些 CPU 密集计算（Zlib，Crypto）会启用 Node 的线程池，而线程池默认大小为 <strong>4</strong>，因此线程数变成了 11。</p><p>我们可以手动更改线程池默认大小：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">process</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">UV_THREADPOOL_SIZE</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">64</span><span class="token punctuation">;</span></div></pre></div><p>码一行代码轻松把线程变成 71。</p><p><strong>Libuv</strong></p><p>Libuv 是一个跨平台的异步 I/O 库，它结合了 UNIX 下的 libev 和 Windows 下的 IOCP 的特性，最早由 Node 的作者开发，专门为 Node 提供多平台下的异步 I/O 支持。Libuv 本身是由 C++ 语言实现的，Node 中的非阻塞 I/O 以及事件循环的底层机制都是由 libuv 实现的。</p><p>在 Window 环境下，libuv 直接使用 Windows 的 IOCP 来实现异步 IO。在非 Windows 环境下，libuv 使用多线程来模拟异步 I/O。</p><p>⚠️ 注意下面我要说的话，Node 的异步调用是由 libuv 来支持的，以上面的读取文件的例子，读文件实质的系统调用是由 libuv 来完成的，Node 只是负责调用 libuv 的接口，等数据返回后再执行对应的回调方法。</p><h3 id="线程创建方式"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#线程创建方式"><span class="icon icon-link"></span></a>线程创建方式</h3><p>直到 Node 10.5.0 的发布，官方才给出了一个实验性质的模块 <code>worker_threads</code> 给 Node 提供真正的多线程能力。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isMainThread</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  parentPort</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workerData</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  threadId</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">MessageChannel</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">MessagePort</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">Worker</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;worker_threads&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token plain">__filename</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">workerData</span><span class="token operator">:</span><span class="token plain"> i </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;exit&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">main: worker stopped with exit code </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">code</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    worker</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">main: receive </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">msg</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token plain">msg </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">worker: workerDate </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">workerData</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  parentPort</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">worker: receive </span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">msg</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    parentPort</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token plain">workerData</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isMainThread</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">mainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">workerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>上述代码在主线程中开启五个子线程，并且主线程向子线程发送简单的消息。</p><p>由于 worker_thread 目前仍然处于实验阶段，所以启动时需要增加 <code>--experimental-worker flag</code>，运行后观察活动监视器，开启了 5 个子线程。</p><p><strong>worker_thread 模块</strong></p><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/nodejs/node/blob/master/lib/worker_threads.js">worker_thread 核心代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>worker_thread 模块中有 4 个对象和 2 个类，可以自己去看上面的源码。</p><ul><li>isMainThread: 是否是主线程，源码中是通过 threadId === 0 进行判断的。</li><li>MessagePort: 用于线程之间的通信，继承自 EventEmitter。</li><li>MessageChannel: 用于创建异步、双向通信的通道实例。</li><li>threadId: 线程 ID。</li><li>Worker: 用于在主线程中创建子线程。第一个参数为 filename，表示子线程执行的入口。</li><li>parentPort: 在 worker 线程里是表示父进程的 MessagePort 类型的对象，在主线程里为 null</li><li>workerData: 用于在主进程中向子进程传递数据（data 副本）</li></ul><h2 id="其他"><a aria-hidden="true" tabindex="-1" href="/black-node-guidebook//system/process/tmp#其他"><span class="icon icon-link"></span></a>其他</h2><p>操作进程对于服务端而言，好比 HTML 之于前端一样基础，想做服务端编程是不可能绕过 Unix/Linux 的。</p><p>在 Linux/Unix/Mac 系统中运行 <code>ps -ef</code> 命令可以看到当前系统中运行的进程，各个参数如下：</p><ul><li>UID：执行该进程的用户 ID</li><li>PID：进程编号</li><li>PPID：该进程的父进程编号</li><li>C：该进程所在的 CPU 利用率</li><li>STIME：进程执行时间</li><li>TTY：进程相关的终端类型</li><li>TIME：进程所占用的 CPU 时间</li><li>CMD：创建该进程的指令</li></ul><p>关于进程以及操作系统一些更深入细节推荐阅读 <a target="_blank" rel="noopener noreferrer" href="https://book.douban.com/subject/25900403/">《Unix 高级编程》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 等书籍来了解。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-node-guidebook/edit/master/docs/system/process/tmp.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2023/7/9 19:47:35</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/black-node-guidebook/umi.js"></script>
  </body>
</html>
